service: aare-ai

provider:
  name: aws
  runtime: python3.11
  region: us-west-2
  stage: ${opt:stage, 'prod'}  # Changed default to 'prod'
  environment:
    ONTOLOGY_BUCKET: ${self:custom.ontologyBucket}
    VERIFICATION_TABLE: ${self:custom.verificationTable}
    STAGE: ${self:provider.stage}
    DEPLOY_VERSION: "0.2.9-fix2"
  apiGateway:
    apiKeys:
      - name: aare-ai-key-${self:provider.stage}
        description: API key for aare.ai ${self:provider.stage}
    usagePlan:
      quota:
        limit: 100000
        period: DAY
      throttle:
        burstLimit: 500
        rateLimit: 200
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:ListBucket
          Resource:
            - arn:aws:s3:::${self:custom.ontologyBucket}
            - arn:aws:s3:::${self:custom.ontologyBucket}/*
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:Query
          Resource:
            - !GetAtt VerificationTable.Arn

custom:
  ontologyBucket: aare-ai-ontologies-${self:provider.stage}
  verificationTable: aare-ai-verifications-${self:provider.stage}
  pythonRequirements:
    dockerizePip: false
    slim: true
    strip: false
    fileName: requirements.txt
    pythonBin: python3
    useStaticCache: false
    useDownloadCache: false

package:
  patterns:
    - '!node_modules/**'
    - '!demo-ui/**'
    - '!tests/**'
    - '!.git/**'
    - '!ontologies/**'
    - '!package*.json'
    - handlers/**

functions:
  verify:
    handler: handlers/handler.handler
    description: aare.ai Z3 SMT verification engine - Production
    timeout: 30
    memorySize: 2048
    events:
      - http:
          path: /verify
          method: post
          cors:
            origins:
              - https://aare.ai
              - https://www.aare.ai
              - http://localhost:8000
              - http://localhost:3000
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
              - X-Amz-User-Agent
            allowCredentials: false
          private: true

resources:
  Resources:
    VerificationTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.verificationTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: verification_id
            AttributeType: S
          - AttributeName: ontology_name
            AttributeType: S
          - AttributeName: timestamp
            AttributeType: S
        KeySchema:
          - AttributeName: verification_id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: ontology-timestamp-index
            KeySchema:
              - AttributeName: ontology_name
                KeyType: HASH
              - AttributeName: timestamp
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
    GatewayResponseDefault4XX:
      Type: AWS::ApiGateway::GatewayResponse
      Properties:
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'https://aare.ai'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
          gatewayresponse.header.Access-Control-Allow-Methods: "'OPTIONS,POST'"
        ResponseType: DEFAULT_4XX
        RestApiId:
          Ref: ApiGatewayRestApi
    GatewayResponseDefault5XX:
      Type: AWS::ApiGateway::GatewayResponse
      Properties:
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'https://aare.ai'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
          gatewayresponse.header.Access-Control-Allow-Methods: "'OPTIONS,POST'"
        ResponseType: DEFAULT_5XX
        RestApiId:
          Ref: ApiGatewayRestApi
  Outputs:
    ApiEndpoint:
      Description: API Gateway endpoint URL
      Value:
        Fn::Sub: https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com/${self:provider.stage}

